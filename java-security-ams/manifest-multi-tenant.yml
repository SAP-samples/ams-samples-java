# SPDX-FileCopyrightText: 2020
#
# SPDX-License-Identifier: Apache-2.0

---
# Configuration:
# configured for EU10. For other landscapes, please adopt LANDSCAPE_APPS_DOMAIN in ../vars.yml
# If the route is occupied, you might need to change ID in ../vars.yml
applications:
  - name: java-ams
    instances: 1
    memory: 896M
    health-check-type: http
    health-check-http-endpoint: /health
    routes:
      - route: java-ams-((ID)).((LANDSCAPE_APPS_DOMAIN))
      - route: java-ams-((ID)).cert.((LANDSCAPE_APPS_DOMAIN))
    host:
    path: target//java-security-ams.war
    services:
      - name: java-ams-ias
        parameters: { "credential-type": "X509_GENERATED" }
      - java-ams-sms
    buildpacks:
      - https://github.com/SAP/cloud-authorization-buildpack/releases/latest/download/opa_buildpack.zip
      - java_buildpack
    env:
      JBP_CONFIG_OPEN_JDK_JRE: '[memory_calculator: {headroom: 10}]'
      AMS_DCL_ROOT: "/WEB-INF/classes/"

  #----------------------------------------------------------
  # Application Router
  #----------------------------------------------------------
  - name: java-ams-approuter
    path: approuter
    buildpacks:
      - nodejs_buildpack
    memory: 128M
    routes:
      - route: ((PROVIDER_TENANT_ID))--((PROVIDER_TENANT_NAME))-ar-((ID)).((LANDSCAPE_APPS_DOMAIN))
    services:
      - name: java-ams-ias
        parameters: { "credential-type": "X509_GENERATED" }
    env:
      TENANT_HOST_PATTERN: ^(.*)-ar-((ID)).((LANDSCAPE_APPS_DOMAIN))
      destinations: >
        [
          {"name":"ams-java-app-destination",
           "url":"https://java-ams-((ID)).((LANDSCAPE_APPS_DOMAIN))",
           "forwardAuthToken": true}
        ]
